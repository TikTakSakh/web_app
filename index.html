<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Ванилька — Мини-магазин</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@300;400;600;700&family=Varela+Round&display=swap" rel="stylesheet" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    /* ─── Reset & Base ──────────────────────────────────────── */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:         #FFF5F0;
      --bg-card:    #FFFFFF;
      --primary:    #D4856A;
      --primary-soft:#E8A992;
      --accent:     #C2A0D0;
      --accent-soft:#DCCCE5;
      --mint:       #A8D5BA;
      --mint-soft:  #C5E8D3;
      --cream:      #FFF0DB;
      --text:       #5A3E36;
      --text-light: #8D7068;
      --text-muted: #B09A93;
      --border:     #F0DDD6;
      --shadow:     rgba(180, 130, 110, .12);
      --btn-order:  linear-gradient(135deg, #D4856A 0%, #C2A0D0 100%);
      --btn-order-hover: linear-gradient(135deg, #C57A60 0%, #B290C0 100%);
      --radius:     16px;
      --radius-sm:  10px;
    }

    html { font-size: 16px; }
    body {
      font-family: 'Nunito Sans', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding-bottom: 100px;
      -webkit-font-smoothing: antialiased;
    }

    /* ─── Header ────────────────────────────────────────────── */
    .header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: rgba(255, 245, 240, .85);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      padding: 16px 20px 12px;
      text-align: center;
      border-bottom: 1px solid var(--border);
    }
    .header h1 {
      font-family: 'Varela Round', sans-serif;
      font-size: 1.35rem;
      color: var(--primary);
      letter-spacing: 0.02em;
    }
    .header p {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 2px;
    }

    /* ─── Catalog ───────────────────────────────────────────── */
    .catalog {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 16px 16px 0;
    }

    /* ─── Card ──────────────────────────────────────────────── */
    .card {
      background: var(--bg-card);
      border-radius: var(--radius);
      padding: 16px;
      display: flex;
      align-items: center;
      gap: 14px;
      box-shadow: 0 2px 12px var(--shadow);
      border: 1px solid var(--border);
      transition: transform .2s ease, box-shadow .2s ease;
    }
    .card:active {
      transform: scale(.98);
    }

    /* Color accent stripes per card */
    .card .stripe {
      flex-shrink: 0;
      width: 6px;
      height: 54px;
      border-radius: 3px;
    }
    .stripe-pink   { background: var(--primary-soft); }
    .stripe-brown  { background: #A0755A; }
    .stripe-rose   { background: #E0A0A8; }
    .stripe-yellow { background: #E8D08A; }
    .stripe-orange { background: #E8B88A; }
    .stripe-cocoa  { background: #9A7060; }

    .card-info {
      flex: 1;
      min-width: 0;
    }
    .card-name {
      font-family: 'Varela Round', sans-serif;
      font-size: 0.95rem;
      font-weight: 400;
      color: var(--text);
      line-height: 1.3;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .card-price {
      font-size: 0.8rem;
      color: var(--text-light);
      margin-top: 2px;
    }

    /* ─── Quantity Controls ──────────────────────────────────── */
    .qty-controls {
      display: flex;
      align-items: center;
      gap: 0;
      flex-shrink: 0;
    }
    .qty-btn {
      width: 36px;
      height: 36px;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 1.15rem;
      font-weight: 700;
      color: var(--primary);
      background: var(--cream);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background .15s ease, transform .1s ease;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }
    .qty-btn:active {
      transform: scale(.9);
      background: var(--border);
    }
    .qty-btn.minus { border-radius: var(--radius-sm) 0 0 var(--radius-sm); }
    .qty-btn.plus  { border-radius: 0 var(--radius-sm) var(--radius-sm) 0; }

    .qty-value {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      font-weight: 700;
      color: var(--text);
      background: #FFF9F5;
      border-top: 1px solid var(--border);
      border-bottom: 1px solid var(--border);
      user-select: none;
    }

    /* ─── Footer / Order Button ─────────────────────────────── */
    .footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 100;
      padding: 12px 16px;
      padding-bottom: max(12px, env(safe-area-inset-bottom));
      background: rgba(255, 245, 240, .92);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border-top: 1px solid var(--border);
    }

    .order-summary {
      text-align: center;
      font-size: 0.8rem;
      color: var(--text-light);
      margin-bottom: 8px;
      min-height: 18px;
      transition: opacity .2s ease;
    }

    .order-btn {
      display: block;
      width: 100%;
      padding: 15px;
      border: none;
      border-radius: var(--radius);
      background: var(--btn-order);
      color: #FFF;
      font-family: 'Varela Round', sans-serif;
      font-size: 1rem;
      font-weight: 400;
      letter-spacing: 0.03em;
      cursor: pointer;
      transition: opacity .2s ease, transform .15s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .order-btn:active {
      transform: scale(.97);
    }
    .order-btn:disabled {
      opacity: .4;
      cursor: default;
      transform: none;
    }
    .order-btn:not(:disabled):hover {
      background: var(--btn-order-hover);
    }

    /* ─── Empty State ───────────────────────────────────────── */
    .empty-hint {
      text-align: center;
      color: var(--text-muted);
      font-size: 0.85rem;
      padding: 48px 24px;
      line-height: 1.5;
    }

    /* ─── Animations ────────────────────────────────────────── */
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(12px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    .card {
      animation: fadeInUp .35s ease both;
    }
    .card:nth-child(1) { animation-delay: .03s; }
    .card:nth-child(2) { animation-delay: .07s; }
    .card:nth-child(3) { animation-delay: .11s; }
    .card:nth-child(4) { animation-delay: .15s; }
    .card:nth-child(5) { animation-delay: .19s; }
    .card:nth-child(6) { animation-delay: .23s; }

    @media (prefers-reduced-motion: reduce) {
      .card { animation: none; }
      .qty-btn:active, .order-btn:active, .card:active { transform: none; }
    }
  </style>
</head>
<body>

  <header class="header">
    <h1>Ванилька</h1>
    <p>Выберите торты для заказа</p>
  </header>

  <main class="catalog" id="catalog">
    <!-- Cards rendered by JS -->
  </main>

  <footer class="footer">
    <div class="order-summary" id="orderSummary"></div>
    <button class="order-btn" id="orderBtn" disabled>Сделать заказ</button>
  </footer>

  <script>
    /* ── Catalog Data (from Google Drive knowledge base) ──── */
    const CATALOG = [
      { id: 1, name: "Клубничная мечта",     price: 650, stripe: "stripe-pink"   },
      { id: 2, name: "Шоколадный капучино",   price: 700, stripe: "stripe-brown"  },
      { id: 3, name: "Малиновый рассвет",     price: 680, stripe: "stripe-rose"   },
      { id: 4, name: "Лимонный бриз",         price: 670, stripe: "stripe-yellow" },
      { id: 5, name: "Тропикана",             price: 720, stripe: "stripe-orange" },
      { id: 6, name: "Сникерс",               price: 820, stripe: "stripe-cocoa"  },
    ];

    /* ── State ──────────────────────────────────────────────── */
    const quantities = {};
    CATALOG.forEach(item => quantities[item.id] = 0);

    /* ── DOM References ──────────────────────────────────────── */
    const catalogEl  = document.getElementById("catalog");
    const summaryEl  = document.getElementById("orderSummary");
    const orderBtn   = document.getElementById("orderBtn");

    /* ── Telegram WebApp ────────────────────────────────────── */
    const tg = window.Telegram?.WebApp;
    if (tg) {
      tg.ready();
      tg.expand();
      // Match Telegram theme if available
      if (tg.themeParams?.bg_color) {
        document.documentElement.style.setProperty("--bg", tg.themeParams.bg_color);
      }
    }

    /* ── Render Catalog ──────────────────────────────────────── */
    function renderCatalog() {
      catalogEl.innerHTML = CATALOG.map(item => `
        <div class="card" data-id="${item.id}">
          <div class="stripe ${item.stripe}"></div>
          <div class="card-info">
            <div class="card-name">${item.name}</div>
            <div class="card-price">${item.price} ₽</div>
          </div>
          <div class="qty-controls">
            <button class="qty-btn minus" data-id="${item.id}" aria-label="Уменьшить">−</button>
            <div class="qty-value" id="qty-${item.id}">0</div>
            <button class="qty-btn plus" data-id="${item.id}" aria-label="Увеличить">+</button>
          </div>
        </div>
      `).join("");
    }

    /* ── Update UI ───────────────────────────────────────────── */
    function updateUI() {
      let totalItems = 0;
      let totalPrice = 0;

      CATALOG.forEach(item => {
        const qty = quantities[item.id];
        const qtyEl = document.getElementById(`qty-${item.id}`);
        if (qtyEl) qtyEl.textContent = qty;
        totalItems += qty;
        totalPrice += qty * item.price;
      });

      if (totalItems > 0) {
        summaryEl.textContent = `${totalItems} шт. на сумму ${totalPrice} ₽`;
        orderBtn.disabled = false;
      } else {
        summaryEl.textContent = "";
        orderBtn.disabled = true;
      }
    }

    /* ── Event Handlers ──────────────────────────────────────── */
    catalogEl.addEventListener("click", (e) => {
      const btn = e.target.closest(".qty-btn");
      if (!btn) return;

      const id = Number(btn.dataset.id);
      if (btn.classList.contains("plus")) {
        quantities[id] = Math.min(quantities[id] + 1, 99);
      } else if (btn.classList.contains("minus")) {
        quantities[id] = Math.max(quantities[id] - 1, 0);
      }
      updateUI();
    });

    orderBtn.addEventListener("click", () => {
      if (orderBtn.disabled) return;

      const items = CATALOG
        .filter(item => quantities[item.id] > 0)
        .map(item => ({
          name: item.name,
          quantity: quantities[item.id],
          price: item.price,
        }));

      const totalPrice = items.reduce((sum, i) => sum + i.quantity * i.price, 0);

      const payload = JSON.stringify({
        type: "order",
        items: items,
        total: totalPrice,
      });

      if (tg) {
        tg.sendData(payload);
        // App auto-closes after sendData
      } else {
        // Fallback for testing outside Telegram
        console.log("Order payload:", payload);
        alert("Заказ отправлен!\n\n" + payload);
      }
    });

    /* ── Init ────────────────────────────────────────────────── */
    renderCatalog();
    updateUI();
  </script>
</body>
</html>
